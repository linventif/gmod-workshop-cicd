name: Publish Example Addon

on:
  push:
    branches: [main]

  workflow_run:
    workflows: ["Build and publish uploader image"]
    types:
      - completed

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Pull uploader image
        run: docker pull ghcr.io/linventif/gmod-workshop-cicd:latest

      - name: Run uploader
        env:
          STEAM_USER: ${{ secrets.STEAM_USER }}
          STEAM_PASS: ${{ secrets.STEAM_PASS }}
          STEAM_SHARED_SECRET: ${{ secrets.STEAM_SHARED_SECRET }}
          PUBLISHED_FILE_ID: ${{ secrets.EXAMPLE_ADDON_ID }}
          CONTENT_PATH: /data/example_addon
          PREVIEW_FILE: /data/example_addon/materials/example_addon/logo.png
          TITLE: "Example Addon"
          DESCRIPTION: "Automated CI release"
          VISIBILITY: "0"
          CHANGE_NOTE: "Automated build"
        run: |
          docker run --rm \
            -e STEAM_USER \
            -e STEAM_PASS \
            -e STEAM_SHARED_SECRET \
            -e PUBLISHED_FILE_ID \
            -e CONTENT_PATH \
            -e PREVIEW_FILE \
            -e TITLE \
            -e DESCRIPTION \
            -e VISIBILITY \
            -e CHANGE_NOTE \
            -v ${{ github.workspace }}/example_addon:/data/example_addon:ro \
            ghcr.io/linventif/gmod-workshop-cicd:latest
